(()=>{const e="media-cache-v3",o="/offline.html";self.addEventListener("install",n=>{console.log("ğŸ”§ Service Worker installing..."),n.waitUntil(caches.open(e).then(e=>(console.log("ğŸ“¦ Caching essential resources..."),e.addAll(["/",o,"/icons/icon-192x192.png","/icons/icon-96x96.png"]).catch(e=>{console.error("Failed to cache some resources:",e)}))).then(()=>(console.log("âœ… Service Worker installed"),self.skipWaiting())))}),self.addEventListener("activate",o=>{console.log("ğŸš€ Service Worker activating...");const n=[e];o.waitUntil(caches.keys().then(e=>Promise.all(e.map(e=>{if(!n.includes(e))return console.log("ğŸ—‘ï¸ Deleting old cache:",e),caches.delete(e)}))).then(()=>(console.log("âœ… Service Worker activated"),self.clients.claim())))}),self.addEventListener("push",function(e){if(console.log("ğŸ“¬ Push notification received"),!e.data)return void console.warn("âš ï¸ Push event has no data");let o;try{o=e.data.json(),console.log("ğŸ“‹ Parsed payload:",o)}catch(n){console.error("âŒ Failed to parse push data as JSON:",n);try{o=JSON.parse(e.data.text())}catch(n){console.error("âŒ Failed to parse as text:",n),o={title:"Notification",body:e.data.text()}}}const n=o.title||"Notification",i=o.body||"",t=o.icon||"/icons/icon-192x192.png",c=o.badge||"/icons/icon-96x96.png",s=o.url||"/",r={body:i,icon:t,badge:c,vibrate:[200,100,200],data:{url:s,dateOfArrival:Date.now(),clickAction:s},actions:[{action:"open",title:"Open",icon:"/icons/icon-96x96.png"},{action:"close",title:"Dismiss"}],tag:"notification-"+Date.now(),requireInteraction:!1,silent:!1};console.log("ğŸ”” Showing notification:",n,r),e.waitUntil(self.registration.showNotification(n,r).then(()=>{console.log("âœ… Notification displayed successfully")}).catch(e=>{console.error("âŒ Failed to show notification:",e)}))}),self.addEventListener("notificationclick",function(e){var o,n;if(console.log("ğŸ‘† Notification clicked, action:",e.action),e.notification.close(),"close"===e.action)return void console.log("User dismissed notification");const i=(null===(o=e.notification.data)||void 0===o?void 0:o.url)||(null===(n=e.notification.data)||void 0===n?void 0:n.clickAction)||"/";console.log("ğŸ”— Opening URL:",i),e.waitUntil(clients.matchAll({type:"window",includeUncontrolled:!0}).then(e=>{console.log("ğŸ” Found",e.length,"open windows");for(const o of e){const e=new URL(o.url),n=new URL(i,self.location.origin);if(e.pathname===n.pathname&&"focus"in o)return console.log("âœ… Focusing existing window"),o.focus()}if(clients.openWindow)return console.log("ğŸ†• Opening new window"),clients.openWindow(i)}).catch(e=>{console.error("âŒ Error handling notification click:",e)}))}),self.addEventListener("fetch",n=>{"GET"===n.request.method&&n.request.url.startsWith("http")&&n.respondWith(caches.match(n.request).then(i=>i?(console.log("ğŸ“¦ Serving from cache:",n.request.url),i):fetch(n.request).then(o=>{if(!o||200!==o.status||"error"===o.type)return o;const i=n.request.url;if(i.includes("/media/")||i.includes("/icons/")||i.includes("/images/")){const t=o.clone();caches.open(e).then(e=>{console.log("ğŸ’¾ Caching:",i),e.put(n.request,t)}).catch(e=>console.error("Failed to cache:",e))}return o}).catch(e=>{if(console.error("âŒ Fetch failed:",e),"navigate"===n.request.mode)return caches.match(o);throw e})))}),self.addEventListener("pushsubscriptionchange",e=>{console.log("ğŸ”„ Push subscription changed"),e.waitUntil(self.registration.pushManager.subscribe(e.oldSubscription.options).then(e=>(console.log("âœ… Resubscribed to push notifications"),fetch("/api/push/subscribe",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({subscription:e})}))).catch(e=>{console.error("âŒ Failed to resubscribe:",e)}))}),self.addEventListener("error",e=>{console.error("âŒ Service Worker error:",e.error)}),self.addEventListener("unhandledrejection",e=>{console.error("âŒ Unhandled promise rejection in SW:",e.reason)}),console.log("ğŸ‰ Service Worker script loaded")})();